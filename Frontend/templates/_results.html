<div class="search_result">
    <h4> Conferences Results: </h4>
    {% if articles %}
      {% for article in articles %}

              <div class="mb-4 border border-1 border-dark p-2 text-start bg-white rounded-3">
                  <h5 class="conference-header mb-1">
                      <strong>{{ loop.index }}.</strong>
                      {{ article._id }}

                      <a href="{{article.url}}" target="_blank"> <!-- add url here -->
                        <span class="full-url">{{  article.get('title', 'N/A')}}</span> <!-- add url here -->
                        <span class="short-url">Go to Page &#10172;</span>
                      </a>
                  </h5>
                  {% if session_user_name and session_user_name.userinfo %}
                    {% set is_fav = article._id in favorite_ids %}
                    <button
                      type="button"
                      class="btn btn-sm favorite-btn {{ 'btn-success' if is_fav else 'btn-outline-primary' }}"
                      data-conference-id="{{ article._id }}"
                      data-state="{{ 'saved' if is_fav else 'empty' }}"
                      aria-pressed="{{ 'true' if is_fav else 'false' }}"
                      aria-label="Toggle favorite"
                    >
                      {{ 'âœ“ Saved!' if is_fav else 'â˜† Favorite' }}
                    </button>
                  {% else %}
                    <button class="btn btn-outline-secondary flex-fill" disabled title="Login to favorite a conference">
                      ðŸ”’ Favorite
                    </button>
                  {% endif %}

                  {% if session_user_name and session_user_name.userinfo %}
                    <a href="{{ url_for('conferences.edit_conference', conf_id=article._id) }}"
                      class="btn btn-warning btn-sm ms-2">
                      Edit
                    </a>
                  {% else %}
                    <button class="btn btn-outline-secondary flex-fill" disabled title="Login to edit a conference">
                      ðŸ”’ Edit
                    </button>
                  {% endif %}

                  <span class="text-muted me-3">Location: {{ (article.city, article.country) | city_country}}</span>
                  <span class="text-muted me-3">Start: {{ article.start | format_date }}</span>
                  <span class="text-muted">End: {{ article.end | format_date }}</span>

                  <!-- Calendar buttons -->
                  <div class="mt-2">
                      <a 
                        href="https://www.google.com/calendar/render?action=TEMPLATE&text={{ article._id | urlencode }}&dates={{ article.start | to_gcal_datetime }}/{{ article.end | to_gcal_datetime }}&location={{ (article.city ~ ', ' ~ article.country) | urlencode }}&details={{ article.url | urlencode }}" 
                        target="_blank" 
                        class="google-callendar-button btn btn-sm me-2">
                        Add to Google Calendar
                      </a>

                      <a href="https://outlook.office.com/calendar/0/deeplink/compose?
                        allday=false
                        &body={{ article.topics | urlencode }}
                        &enddt={{ article.end | urlencode }}
                        &location={{ (article.city ~ ', ' ~ article.country) | urlencode }}
                        &path=%2Fcalendar%2Faction%2Fcompose
                        &rru=addevent
                        &startdt={{ article.start | urlencode }}
                        &subject={{ article._id | urlencode }}"
                        target="_blank" class="outlook-button btn btn-sm">
                        Add to Outlook
                      </a>
                    </div>
                  
                  <!-- Topics are hidden by default -->
                  <p class="mt-1 text-muted" style="font-size: 0.9rem;">
                      Deadline to submit: {{ article.deadline | format_date }} <br>
                      Topics: {{ article.topics | replace('\n', ', ') }}
                  </p>
  
                  <p class="text-muted">Match Score: {{ article.score }}</p>
                
                  <details class="mt-2">
                  <summary style="cursor: pointer;">Ranking &amp; Metrics</summary>
                  <div class="mt-2">

                    {% set core = article.get('core', {}) %}
                    {% set keys = ['CORE2023','CORE2021','CORE2020','CORE2018','CORE2017','CORE2014','CORE2013','ERA2010'] %}

                    {# Show CORE/ERA rows if present #}
                    {% set has_any = false %}
                    <table class="table table-sm mb-2">
                      <tbody>
                        {% for k in keys %}
                          {% if core.get(k) %}
                            {% set has_any = true %}
                            <tr>
                              <th scope="row" class="fw-semibold">{{ k }}</th>
                              <td>{{ core[k] }}</td>
                            </tr>
                          {% endif %}
                        {% endfor %}
                      </tbody>
                    </table>

                    {# h5 metrics #}
                    <div class="small">
                      {% if article.h5_index is not none %}
                        {% set has_any = true %}
                        <span class="badge text-bg-secondary me-1">h5-index: {{ article.h5_index }}</span>
                      {% endif %}
                      {% if article.h5_median is not none %}
                        {% set has_any = true %}
                        <span class="badge text-bg-secondary">h5-median: {{ article.h5_median }}</span>
                      {% endif %}
                    </div>

                    {% if not has_any %}
                      <div class="text-muted small">No ranking data available.</div>
                    {% endif %}
                  </div>
                </details>

                <details class="mt-2">
                  <summary style="cursor: pointer;">User Rankings!</summary>

                  <div>
                    <form class="mt-2" method="POST" action="/user_conference_rating">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <input type="hidden" name="conference_id" value="{{ article._id }}">
                      <div class="row mb-2 align-items-center">
                        <label class="col-6 col-form-label">Welcoming</label>
                        <div class="col-6">
                          <input type="number" class="form-control" name="welcoming_score" min="1" max="10" 
                            value="{{ user_ratings_by_conf.get(article._id, {}).get('welcoming_score', '') }}" required>
                        </div>
                      </div>

                      <div class="row mb-2 align-items-center">
                        <label class="col-6 col-form-label">Insightful</label>
                        <div class="col-6">
                          <input type="number" class="form-control" name="insightful_score" min="1" max="10" 
                            value="{{ user_ratings_by_conf.get(article._id, {}).get('insightful_score', '') }}" required>
                        </div>
                      </div>

                      <div class="row mb-2 align-items-center">
                        <label class="col-6 col-form-label">Networking</label>
                        <div class="col-6">
                          <input type="number" class="form-control" name="networking_score" min="1" max="10" 
                            value="{{ user_ratings_by_conf.get(article._id, {}).get('networking_score', '') }}" required>
                        </div>
                      </div>

                      <div class="row mb-2 align-items-center">
                        <label class="col-6 col-form-label">Interactivity</label>
                        <div class="col-6">
                          <input type="number" class="form-control" name="interactivity_score" min="1" max="10" 
                            value="{{ user_ratings_by_conf.get(article._id, {}).get('interactivity_score', '') }}" required>
                        </div>
                      </div>

                      <div class="row mb-2 align-items-center">
                        <label class="col-6 col-form-label">High-Caliber Attendees</label>
                        <div class="col-6">
                          <input type="number" class="form-control" id="caliber_score" name="caliber_score" min="1" max="10" 
                            value="{{ user_ratings_by_conf.get(article._id, {}).get('caliber_score', '') }}" required>
                        </div>
                      </div>

                      <div class="row mb-2 align-items-center">
                        <label class="col-6 col-form-label">Worthwhile</label>
                        <div class="col-6">
                          <input type="number" class="form-control" id="worthwhile_score" name="worthwhile_score" min="1" max="10" 
                            value="{{ user_ratings_by_conf.get(article._id, {}).get('worthwhile_score', '') }}" required>
                        </div>
                      </div>
                      <input type="submit" value="Save your Ratings">
                    </form>

                  </div>
                </details>


              </div>
              

      {% endfor %}
    {% else %}
      {% if ID_query %}
        <h3 class="text-muted text-center">Sorry, "{{ ID_query }}" could not be found. Not even AI could make this one up.</h3>
      {% endif %}
    {% endif %}
</div>