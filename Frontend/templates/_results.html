<div class="search_result">
    <h4> Conferences Results: </h4>
    {% if articles %}
      {% for article in articles %}
          {% if article.metadata.url %}
              <div class="mb-4 border border-1 border-dark p-2 btn text-start bg-white rounded-3">
                  <h5 class="mb-1">
                      <strong>{{ loop.index }}.</strong>
                      {{ article.id }}
                      <a href="{{ article.metadata.url }}" target="_blank" rel="noopener noreferrer" style="margin-left: 10px; font-weight: normal; font-size: 0.9em;">
                      {{ article.metadata.url }}
                      </a>
                  </h5>
                  {% if session_user_name and session_user_name.userinfo %}
                    {% set is_fav = article.id in favorite_ids %}
                    <button
                      type="button"
                      class="btn btn-sm favorite-btn {{ 'btn-success' if is_fav else 'btn-outline-primary' }}"
                      data-conference-id="{{ article.id }}"
                      data-state="{{ 'saved' if is_fav else 'empty' }}"
                      aria-pressed="{{ 'true' if is_fav else 'false' }}"
                      aria-label="Toggle favorite"
                    >
                      {{ '‚úì Saved!' if is_fav else '‚òÜ Favorite' }}
                    </button>
                  {% else %}
                    <button class="btn btn-outline-secondary flex-fill" disabled title="Login to favorite a conference">
                      üîí Favorite
                    </button>
                  {% endif %}

                  {% if session_user_name and session_user_name.userinfo %}
                    <a href="{{ url_for('edit_conference', conf_id=article.id) }}"
                      class="btn btn-warning btn-sm ms-2">
                      Edit
                    </a>
                  {% else %}
                    <button class="btn btn-outline-secondary flex-fill" disabled title="Login to edit a conference">
                      üîí Edit
                    </button>
                  {% endif %}

                
                  <span class="text-muted me-3">Location: {{ (article.metadata.city, article.metadata.country) | city_country}}</span>
                  <span class="text-muted me-3">Start: {{ article.metadata.start | format_date }}</span>
                  <span class="text-muted">End: {{ article.metadata.end | format_date }}</span>

                  <!-- Calendar buttons -->
                  <div class="mt-2">
                      <a 
                        href="https://www.google.com/calendar/render?action=TEMPLATE&text={{ article.id | urlencode }}&dates={{ article.metadata.start | to_gcal_datetime }}/{{ article.metadata.end | to_gcal_datetime }}&location={{ (article.metadata.city ~ ', ' ~ article.metadata.country) | urlencode }}&details={{ article.metadata.url | urlencode }}" 
                        target="_blank" 
                        class="google-callendar-button btn btn-sm me-2">
                        Add to Google Calendar
                      </a>

                      <a href="https://outlook.office.com/calendar/0/deeplink/compose?
                        allday=false
                        &body={{ article.metadata.topics | urlencode }}
                        &enddt={{ article.metadata.end | urlencode }}
                        &location={{ (article.metadata.city ~ ', ' ~ article.metadata.country) | urlencode }}
                        &path=%2Fcalendar%2Faction%2Fcompose
                        &rru=addevent
                        &startdt={{ article.metadata.start | urlencode }}
                        &subject={{ article.id | urlencode }}"
                        target="_blank" class="outlook-button btn btn-sm">
                        Add to Outlook
                      </a>
                    </div>
                  
                  <!-- Topics are hidden by default -->
                  <p class="mt-1 text-muted" style="font-size: 0.9rem;">
                      Deadline to submit: {{ article.metadata.deadline | format_date }} <br>
                      Topics: {{ article.metadata.topics | replace('\n', ', ') }}
                  </p>
  
                  <p class="text-muted">Match Score: {{ article.score | round(4) }}</p>

                  <details class="mt-2">
                      <summary style="cursor: pointer;">Conference Ranking Scores</summary>
                      <ul class="list-unstyled mt-1 ms-3">
                          {% set scores = [] %}
                          {% for key, value in article.metadata.items() %}
                              {% if key.startswith('CORE') or key.startswith('ERA') or key.startswith('h5') %}
                                  {% set _ = scores.append((key, value)) %}
                              {% endif %}
                          {% endfor %}

                          {% for key, value in scores | sort(attribute=0, reverse=true) %}
                              <li><strong>{{ key }}:</strong> {{ value }}</li>
                          {% endfor %}
                      </ul>
                  </details>
              </div>
          {% endif %}
      {% endfor %}
    {% else %}
      {% if ID_query %}
        <h3 class="text-muted text-center">Sorry, "{{ ID_query }}" could not be found. Not even AI could make this one up.</h3>
      {% endif %}
    {% endif %}
</div>
<script>
  // ---- helpers ----
  function getCsrfToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    return meta ? meta.getAttribute('content') : null;
  }

  function setFavButtonState(btn, saved) {
    if (saved) {
      btn.classList.remove('btn-outline-primary');
      btn.classList.add('btn-success');
      btn.textContent = '‚úì Saved!';
      btn.dataset.state = 'saved';
      btn.setAttribute('aria-pressed', 'true');
    } else {
      btn.classList.remove('btn-success');
      btn.classList.add('btn-outline-primary');
      btn.textContent = '‚òÜ Favorite';
      btn.dataset.state = 'empty';
      btn.setAttribute('aria-pressed', 'false');
    }
  }

  // ---- event delegation (works for current and future results) ----
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.favorite-btn');
    if (!btn) return;

    const csrfToken = getCsrfToken();
    if (!csrfToken) {
      alert('CSRF token missing. Make sure <meta name="csrf-token" ...> is in your base template.');
      return;
    }

    const id = btn.dataset.conferenceId;
    btn.disabled = true;

    try {
      const res = await fetch('/favorite', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,     // Flask-WTF checks this
          'X-Requested-With': 'fetch'   // tells server to return JSON
        },
        body: JSON.stringify({ conference_id: id })
      });

      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error(data.error || 'Request failed');

      setFavButtonState(btn, data.status === 'added');
    } catch (err) {
      console.error(err);
      alert('‚ùå Failed to save: ' + err.message);
    } finally {
      btn.disabled = false;
    }
  });
</script>