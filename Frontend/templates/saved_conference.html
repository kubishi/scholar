{% extends "base.html" %}

{% block body %}
<picture class="bg-image">
  <img src="static/img/background3.jpg" alt="Nothing Honey" class="w-full h-screen object-cover blur-50 brightness-50 scale-105">
</picture>

<nav class="navbar mb-2">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="/">
        <img src="static/img/logo_bg.png" width="40" height="40" class="menu_logo me-2 rounded-2" alt="">
        <div class="d-flex flex-column">
          <span class="fs-5 fw-bold text-dark">Kubishi Scholar</span>
          <span class="title_subtext text-muted">Semantic Conference Discovery</span>
        </div>
      </a>
  </div>
</nav>

<div class="search_result">
  <h4> Conferences Results: </h4>
  {% if articles %}
    {% for article in articles %}
        {% if article.metadata.url %}
            <div class="mb-4 border border-1 border-dark p-2 btn text-start bg-white rounded-3">
                <h5 class="mb-1">
                    <strong>{{ loop.index }}.</strong>
                    {{ article.id }}
                    <a href="{{ article.metadata.url }}" target="_blank" rel="noopener noreferrer" style="margin-left: 10px; font-weight: normal; font-size: 0.9em;">
                    {{ article.metadata.url }}
                    </a>
                </h5>
                {% if session_user_name and session_user_name.userinfo %}
                  {% set is_fav = article.id in favorite_ids %}
                  <button
                    type="button"
                    class="btn btn-sm favorite-btn {{ 'btn-success' if is_fav else 'btn-outline-primary' }}"
                    data-conference-id="{{ article.id }}"
                    data-state="{{ 'saved' if is_fav else 'empty' }}"
                    aria-pressed="{{ 'true' if is_fav else 'false' }}"
                    aria-label="Toggle favorite"
                  >
                    {{ 'âœ“ Saved!' if is_fav else 'â˜† Favorite' }}
                  </button>
                {% else %}
                  <button class="btn btn-outline-secondary flex-fill" disabled title="Login to favorite a conference">
                    ðŸ”’ Remove
                  </button>
                {% endif %}

                {% if session_user_name and session_user_name.userinfo %}
                  <a href="{{ url_for('edit_conference', conf_id=article.id) }}"
                    class="btn btn-warning btn-sm ms-2">
                    Edit
                  </a>
                {% else %}
                  <button class="btn btn-outline-secondary flex-fill" disabled title="Login to edit a conference">
                    ðŸ”’ Edit
                  </button>
                {% endif %}

              
                <span class="text-muted me-3">Location: {{ (article.metadata.city, article.metadata.country) | city_country}}</span>
                <span class="text-muted me-3">Start: {{ article.metadata.start | format_date }}</span>
                <span class="text-muted">End: {{ article.metadata.end | format_date }}</span>

                <!-- Calendar buttons -->
                <div class="mt-2">
                    <a 
                      href="https://www.google.com/calendar/render?action=TEMPLATE&text={{ article.id | urlencode }}&dates={{ article.metadata.start | to_gcal_datetime }}/{{ article.metadata.end | to_gcal_datetime }}&location={{ (article.metadata.city ~ ', ' ~ article.metadata.country) | urlencode }}&details={{ article.metadata.url | urlencode }}" 
                      target="_blank" 
                      class="google-callendar-button btn btn-sm me-2">
                      Add to Google Calendar
                    </a>

                    <a href="https://outlook.office.com/calendar/0/deeplink/compose?
                      allday=false
                      &body={{ article.metadata.topics | urlencode }}
                      &enddt={{ article.metadata.end | urlencode }}
                      &location={{ (article.metadata.city ~ ', ' ~ article.metadata.country) | urlencode }}
                      &path=%2Fcalendar%2Faction%2Fcompose
                      &rru=addevent
                      &startdt={{ article.metadata.start | urlencode }}
                      &subject={{ article.id | urlencode }}"
                      target="_blank" class="outlook-button btn btn-sm">
                      Add to Outlook
                    </a>
                  </div>
                
                <!-- Topics are hidden by default -->
                <p class="mb-1 text-muted topic-line" style="font-size: 0.9rem; display: none;">
                    Deadline to submit: {{ article.metadata.deadline | format_date }} <br>
                    Topics: {{ article.metadata.topics | replace('\n', ', ') }}
                </p>

                <details class="mt-2">
                    <summary style="cursor: pointer;">Conference Ranking Scores</summary>
                    <ul class="list-unstyled mt-1 ms-3">
                        {% set scores = [] %}
                        {% for key, value in article.metadata.items() %}
                            {% if key.startswith('CORE') or key.startswith('ERA') or key.startswith('h5') %}
                                {% set _ = scores.append((key, value)) %}
                            {% endif %}
                        {% endfor %}

                        {% for key, value in scores | sort(attribute=0, reverse=true) %}
                            <li><strong>{{ key }}:</strong> {{ value }}</li>
                        {% endfor %}
                    </ul>
                </details>
            </div>
        {% endif %}
    {% endfor %}
  {% else %}
    {% if ID_query %}
      <h3 class="text-muted text-center">Sorry, "{{ ID_query }}" could not be found. Not even AI could make this one up.</h3>
    {% endif %}
  {% endif %}
</div>

{% endblock %}
